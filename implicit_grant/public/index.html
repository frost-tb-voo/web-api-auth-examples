<!doctype html>
<html>

<head>
  <title>Example of the Implicit Grant flow with Spotify</title>
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <style type="text/css">
    #login,
    #loggedin {
      display: none;
    }

    .text-overflow {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 500px;
    }
  </style>
</head>

<body>
  <div class="container">
    <div id="login">
      <h1>This is an example of the Implicit Grant flow</h1>
      <div class="form-group">
        <label for="client_id">client_id, <a href="https://developer.spotify.com/dashboard/applications" target=_blank>create</a></label>
        <input type="password" class="form-control" id="client_id" placeholder="client_id" value="">
      </div>
      <div class="form-group">
        <label for="redirect_uri">redirect_uri</label>
        <input type="text" class="form-control" id="redirect_uri" placeholder="redirect_uri" value="http://localhost:8888/">
      </div>
      <div class="form-group">
        <label for="artists_length">Max # of artists, 0 is infinite</label>
        <input type="text" class="form-control" id="artists_length" placeholder="artists_length" value="0">
      </div>
      <div class="form-group">
        <label for="albums_length"># of albums per artist</label>
        <input type="text" class="form-control" id="albums_length" placeholder="albums_length" value="1">
      </div>
      <div class="form-group">
        <label for="tracks_length"># of tracks per album</label>
        <input type="text" class="form-control" id="tracks_length" placeholder="tracks_length" value="1">
      </div>
      <button id="login-button" class="btn btn-primary">Log in with Spotify</button>
    </div>
    <div id="loggedin">
      <div id="user-profile">
      </div>
      <div id="oauth">
      </div>
      <div>
        Creating playlist
        <pre id="playlist"></pre>
      </div>
      <div>
        Finding following artists
        <pre id="artists"></pre>
      </div>
      <div>
        Finding albums
        <pre id="albums"></pre>
      </div>
      <div>
        Finding tracks
        <pre id="tracks"></pre>
      </div>
      <div>
        Created playlist
        <pre id="snapshots"></pre>
      </div>
    </div>
  </div>

  <script id="user-profile-template" type="text/x-handlebars-template">
    <h1>Logged in as {{display_name}}</h1>
      <div class="media">
        <div class="pull-left">
          <img class="media-object" width="150" src="{{images.0.url}}" />
        </div>
        <div class="media-body">
          <dl class="dl-horizontal">
            <dt>Display name</dt><dd class="clearfix">{{display_name}}</dd>
            <dt>Id</dt><dd>{{id}}</dd>
            <dt>Email</dt><dd>{{email}}</dd>
            <dt>Spotify URI</dt><dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
            <dt>Link</dt><dd><a href="{{href}}">{{href}}</a></dd>
            <dt>Profile Image</dt><dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
            <dt>Country</dt><dd>{{country}}</dd>
          </dl>
        </div>
      </div>
    </script>

  <script id="oauth-template" type="text/x-handlebars-template">
    <h2>oAuth info</h2>
      <dl class="dl-horizontal">
        <dt>Access token</dt><dd class="text-overflow">{{access_token}}</dd>
      </dl>
    </script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script>
    (async function () {

      let stateKey = 'spotify_auth_state';

      document.getElementById('redirect_uri').value = window.location;

      /**
       * Obtains parameters from the hash of the URL
       * @return Object
       */
      function getHashParams() {
        let hashParams = {};
        let e, r = /([^&;=]+)=?([^&;]*)/g,
          q = window.location.hash.substring(1);
        while (e = r.exec(q)) {
          hashParams[e[1]] = decodeURIComponent(e[2]);
        }
        return hashParams;
      }

      /**
       * Generates a random string containing numbers and letters
       * @param  {number} length The length of the string
       * @return {string} The generated string
       */
      function generateRandomString(length) {
        let text = '';
        let possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';

        for (let i = 0; i < length; i++) {
          text += possible.charAt(Math.floor(Math.random() * possible.length));
        }
        return text;
      };

      function ajaxRequest(url, access_token, type, body) {
        return new Promise((resolv, reject) => {
          $.ajax({
            url: url,
            type: type,
            dataType: 'json',
            contentType: 'application/json',
            data: JSON.stringify(body),
            headers: {
              'Authorization': 'Bearer ' + access_token
            },
            success: (response, status, xhr) => {
              // console.log(url);
              // console.log(response);
              resolv(response);
            },
            error: (xhr, status, error) => {
              console.error(url);
              console.error(error);
              reject(error);
            }
          });
        });
      }

      async function createPlaylist(access_token, me) {
        let userId = me.id;
        let url = 'https://api.spotify.com/v1/users/' + userId + '/playlists';
        let body = {
          name: 'favorites',
          public: true,
          collaborative: false, // should be private if true
          description: 'Favorite artists, ' + artistsLength + 'x' + albumsLength + 'x' + tracksLength + ', ' +
            new Date().toString()
        };
        let playlist = await ajaxRequest(url, access_token, 'POST', body);
        return playlist;
      }

      const artistsLength = document.getElementById('artists_length').value - 0;
      async function getArtists(access_token) {
        let artists = [];
        let next = 'https://api.spotify.com/v1/me/following?type=artist';
        while (next) {
          let following = await ajaxRequest(next, access_token, 'GET');
          for (let item of following.artists.items) {
            for (let key in item) {
              if (key == 'id') {
                continue;
              }
              if (key == 'uri') {
                continue;
              }
              if (key == 'name') {
                continue;
              }
              if (key == 'external_urls') {
                continue;
              }
              if (key == 'images') {
                continue;
              }
              if (key == 'followers') {
                continue;
              }
              if (key == 'popularity') {
                continue;
              }
              delete item[key];
            }
            artists.push(item);
          }
          next = following.artists.next;
        }
        artists.sort(function (aa, bb) {
          return bb.followers.total - aa.followers.total;
        });
        if (artistsLength && artistsLength <= artists.length) {
          artists = artists.slice(0, artistsLength);
        }
        return artists;
      }

      const albumsLength = document.getElementById('albums_length').value - 0;
      async function getAlbums(access_token, artists) {
        let albums = [];
        for (let artist of artists) {
          let albumsPer1 = [];
          let artistId = artist.id;
          next = 'https://api.spotify.com/v1/artists/' + artistId + '/albums';
          while (next) {
            let _albums = await ajaxRequest(next, access_token, 'GET');
            for (let item of _albums.items) {
              for (let key in item) {
                if (key == 'id') {
                  continue;
                }
                if (key == 'uri') {
                  continue;
                }
                if (key == 'name') {
                  continue;
                }
                if (key == 'external_urls') {
                  continue;
                }
                if (key == 'images') {
                  continue;
                }
                if (key == 'release_date') {
                  continue;
                }
                if (key == 'release_date_precision') {
                  continue;
                }
                delete item[key];
              }
              albumsPer1.push(item);
              if (albumsLength && albumsLength <= albumsPer1.length) {
                break; // only 1 albums per artist
              }
            }
            next = _albums.next;
            if (albumsLength && albumsLength <= albumsPer1.length) {
              break; // only 1 albums per artist
            }
          }
          albums = albums.concat(albumsPer1);
        }
        albums.sort(function (aa, bb) {
          return aa.release_date - bb.release_date;
        });
        return albums;
      }

      const tracksLength = document.getElementById('tracks_length').value - 0;
      async function getTracks(access_token, albums) {
        let tracks = [];
        for (let album of albums) {
          let tracksPer1 = [];
          let albumId = album.id;
          next = 'https://api.spotify.com/v1/albums/' + albumId + '/tracks';
          while (next) {
            let _tracks = await ajaxRequest(next, access_token, 'GET');
            for (let item of _tracks.items) {
              for (let key in item) {
                if (key == 'id') {
                  continue;
                }
                if (key == 'uri') {
                  continue;
                }
                if (key == 'name') {
                  continue;
                }
                if (key == 'external_urls') {
                  continue;
                }
                if (key == 'images') {
                  continue;
                }
                if (key == 'preview_url') {
                  continue;
                }
                delete item[key];
              }
              tracks.push(item);
              if (tracksLength && tracksLength <= tracksPer1.length) {
                break; // only 1 tracks per album
              }
            }
            next = _tracks.next;
            if (tracksLength && tracksLength <= tracksPer1.length) {
              break; // only 1 tracks per album
            }
          }
          tracks = tracks.concat(tracksPer1);
        }
        return tracks;
      }

      async function addTracks(access_token, playlist, tracks) {
        let playlistId = playlist.id;
        let url = 'https://api.spotify.com/v1/playlists/' + playlistId + '/tracks';
        for (let ii = 0; ii < tracks.length; ii += 100) {
          let uris = [];
          for (let jj = ii; jj < tracks.length && jj < ii + 100; jj += 1) {
            let track = tracks[jj];
            if (track.uri) {
              uris.push(track.uri);
            }
          }
          body = {
            uris: uris
          };
          let newPlaylist = await ajaxRequest(url, access_token, 'POST', body);
          document.getElementById('snapshots').innerHTML = JSON.stringify(newPlaylist, null, 1);
        }
      }

      let userProfileSource = document.getElementById('user-profile-template').innerHTML,
        userProfileTemplate = Handlebars.compile(userProfileSource),
        userProfilePlaceholder = document.getElementById('user-profile');

      oauthSource = document.getElementById('oauth-template').innerHTML,
        oauthTemplate = Handlebars.compile(oauthSource),
        oauthPlaceholder = document.getElementById('oauth');

      let params = getHashParams();

      let access_token = params.access_token,
        state = params.state,
        storedState = localStorage.getItem(stateKey);

      if (access_token && (state == null || state !== storedState)) {
        alert('There was an error during the authentication');
      } else {
        localStorage.removeItem(stateKey);
        if (access_token) {
          let url = 'https://api.spotify.com/v1/me';
          let me = await ajaxRequest(url, access_token, 'GET');
          userProfilePlaceholder.innerHTML = userProfileTemplate(me);
          $('#login').hide();
          $('#loggedin').show();

          let playlist = await createPlaylist(access_token, me);
          document.getElementById('playlist').innerHTML = JSON.stringify(playlist, null, 1);

          let artists = await getArtists(access_token);
          document.getElementById('artists').innerHTML = JSON.stringify(artists, null, 1);
          let albums = await getAlbums(access_token, artists);
          document.getElementById('albums').innerHTML = JSON.stringify(albums, null, 1);
          let tracks = await getTracks(access_token, albums);
          document.getElementById('tracks').innerHTML = JSON.stringify(tracks, null, 1);

          await addTracks(access_token, playlist, tracks);
        } else {
          $('#login').show();
          $('#loggedin').hide();
        }

        document.getElementById('login-button').addEventListener('click', () => {

          let client_id = document.getElementById('client_id').value; // Your client id
          let redirect_uri = document.getElementById('redirect_uri').value; // Your redirect uri

          let state = generateRandomString(16);

          localStorage.setItem(stateKey, state);
          let scope = '';
          // scope += ' user-read-private';
          // scope += ' user-read-email';
          // read
          // scope += ' user-library-read';
          // scope += ' playlist-read-private';
          // scope += ' user-top-read';
          // scope += ' playlist-read-collaborative';
          scope += ' user-follow-read';
          // scope += ' user-read-playback-state';
          // scope += ' user-read-currently-playing';
          // scope += ' user-read-recently-played';
          // create new list
          scope += ' playlist-modify-public';
          scope += ' playlist-modify-private';

          let url = 'https://accounts.spotify.com/authorize';
          url += '?response_type=token';
          url += '&client_id=' + encodeURIComponent(client_id);
          url += '&scope=' + encodeURIComponent(scope);
          url += '&redirect_uri=' + encodeURIComponent(redirect_uri);
          url += '&state=' + encodeURIComponent(state);

          window.location = url;
        }, false);
      }
    })();
  </script>

</html>